<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.min.edu.model.mapper.SubjectDaoImpl">


<!-- 1-1) 과목 정보 입력 -->
<insert id="subInsertSubject" parameterType="map">
	INSERT INTO SUBJECT (SUB_NUM, SUB_TITLE, SUB_CONTENT, 
						SUB_COD_CODE, SUB_REGDATE,SUB_REG_ID, 
					 	SUB_REG_CODE, SUB_STATUS) 
			VALUES (TO_CHAR(SYSDATE,'yyyyMMdd')||'SUB'||SUB_SEQ.NEXTVAL,#{sub_title},#{sub_content},
					#{sub_cod_code},SYSDATE,#{sub_reg_id},
					'REG'||SUB_REG_SEQ.NEXTVAL,'W')
	</insert>
<!-- 1-2) 과목 등록자 자동 입력 -->
<insert id="subInsertRegister" parameterType="map">
	INSERT INTO SUB_REGISTER(REG_CODE, REG_AUTH ,REG_ID)
				VALUES((SELECT MAX(SUB_REG_CODE) FROM SUBJECT),#{reg_auth},#{reg_id})

</insert>
<!-- 1-3) 과목 커리큘럼 정보 입력 -->
<insert id="subInsertCurriculum" parameterType="map">
	<selectKey keyProperty="sub_num" resultType="java.lang.String" order="BEFORE" >
		SELECT MAX(SUB_NUM) FROM (SELECT SUB_NUM FROM SUBJECT ORDER BY SUB_REGDATE DESC) WHERE ROWNUM = 1
	</selectKey>
	INSERT INTO SUB_CURRICULUM(CUR_NUM,CUR_SUB_NUM,CUR_DETAIL,
							CUR_SUBCONTENT,CUR_VERSION,CUR_TIME,
							CUR_LEVEL,CUR_FILE)
					VALUES('CUR'||SUB_CUR_SEQ.NEXTVAL,#{sub_num},
							#{cur_detail},#{cur_subcontent},#{cur_version},
							#{cur_time},#{cur_level},#{cur_file})
</insert>
<!-- 1-4) 과목 담당강사 자동 입력 -->
<update id="subUpdateInstructor" parameterType="map">
	<selectKey keyProperty="sub_num" resultType="java.lang.String" order="BEFORE" >
		SELECT MAX(SUB_NUM) FROM (SELECT SUB_NUM FROM SUBJECT ORDER BY SUB_REGDATE DESC) WHERE ROWNUM = 1
	</selectKey>
		UPDATE SUBJECT SET SUB_INS = (
								SELECT DISTINCT s.SUB_REG_ID  
									FROM SUBJECT s JOIN SUB_REGISTER sr 
																		ON s.SUB_REG_ID = sr.REG_ID 
								WHERE sr.REG_AUTH =#{reg_auth}	
								AND sr.REG_ID = #{sub_reg_id}
									)
				WHERE SUB_NUM = #{sub_num}
</update>
<!-- 1-5) 관리자가 과목 검수 후 해당 과목에 대한 승인 처리 (과목 상태변경) -->
<!-- 	<foreach collection="sub_nums" item="sub_num" open="(" close=")" separator="," >
		#{sub_num}
	</foreach> -->
<update id="subUpdateStatusA">
	UPDATE SUBJECT 
		SET SUB_STATUS = 'A'  
			WHERE SUB_NUM = #{sub_num}
</update>

<!-- 2) 과목 조회 -->
<!-- 2-1) 관리자의 과목 전체 목록 조회 -->
<select id="subSelectAllAdmin" resultType="SubjectVo">
		SELECT SUB_NUM, SUB_TITLE, SUB_CONTENT, sc.COD_NAME, SUB_REGDATE, 
					SUB_REG_ID, SUB_INS, SUB_STATUS,
					SUB_REJECTION, SUB_SCORE
							FROM SUBJECT s, SUB_CODE sc
								WHERE s.SUB_COD_CODE = sc.COD_CODE 
								ORDER BY SUB_REGDATE DESC
</select>
<!-- 2-2) 과목 상세 조회 -->
<select id="subSelectDetail" parameterType="java.lang.String" resultType="BoardVo">
	SELECT SUB_NUM, SUB_TITLE, SUB_CONTENT , 
				SUB_TAG , sc2.COD_NAME , SUB_REGDATE , 
				SUB_REG_ID , SUB_INS ,
				sc.CUR_DETAIL ,sc.CUR_SUBCONTENT ,sc.CUR_VERSION ,
				sc.CUR_TIME ,sc.CUR_LEVEL ,sc.CUR_FILE 
					FROM SUBJECT s INNER JOIN SUB_CURRICULUM sc 
															ON s.SUB_NUM = sc.CUR_SUB_NUM 
														INNER JOIN SUB_CODE sc2 
															ON s.SUB_COD_CODE = sc2.COD_CODE 
								WHERE SUB_NUM=#{sub_num}
</select>
</mapper>
