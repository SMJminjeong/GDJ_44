<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.min.edu.model.mapper.SubjectDaoImpl">


<!-- 1-1) 과목 정보 입력 -->
<insert id="subInsertSubject" parameterType="SubjectVo">
	INSERT INTO SUBJECT (SUB_NUM, SUB_TITLE, SUB_CONTENT, 
						SUB_COD_CODE, SUB_REGDATE,SUB_REG_ID, 
					 	SUB_REG_CODE, SUB_STATUS) 
			VALUES (TO_CHAR(SYSDATE,'yyyyMMdd')||'SUB'||SUB_SEQ.NEXTVAL,#{sub_title},#{sub_content},
					#{sub_cod_code},SYSDATE,#{sub_reg_id},
					'REG'||SUB_REG_SEQ.NEXTVAL,'W')
	</insert>
<!-- 1-2) 과목 등록자 자동 입력 -->
<insert id="subInsertRegister" parameterType="SubjectVo">
	INSERT INTO SUB_REGISTER(REG_CODE, REG_AUTH ,REG_ID)
				VALUES((SELECT MAX(SUB_REG_CODE) FROM SUBJECT),#{reg_auth},#{reg_id})

</insert>
<!-- 1-3) 과목 커리큘럼 정보 입력 -->
<insert id="subInsertCurriculum" parameterType="SubjectVo">
	<selectKey keyProperty="sub_num" resultType="java.lang.String" order="BEFORE" >
		SELECT MAX(SUB_NUM) FROM (SELECT SUB_NUM FROM SUBJECT ORDER BY SUB_REGDATE DESC) WHERE ROWNUM = 1
	</selectKey>
	INSERT INTO SUB_CURRICULUM(CUR_NUM,CUR_SUB_NUM,CUR_DETAIL,
							CUR_SUBCONTENT,CUR_VERSION,CUR_TIME,
							CUR_LEVEL,CUR_FILE)
					VALUES('CUR'||SUB_CUR_SEQ.NEXTVAL,#{sub_num},
							#{cur_detail},#{cur_subcontent},#{cur_version},
							#{cur_time},#{cur_level},#{cur_file})
</insert>
<!-- 1-4) 과목 담당강사 자동 입력 -->
<update id="subUpdateInstructor" parameterType="SubjectVo">
	<selectKey keyProperty="sub_num" resultType="java.lang.String" order="BEFORE" >
		SELECT MAX(SUB_NUM) FROM (SELECT SUB_NUM FROM SUBJECT ORDER BY SUB_REGDATE DESC) WHERE ROWNUM = 1
	</selectKey>
		UPDATE SUBJECT SET SUB_INS = (
								SELECT DISTINCT s.SUB_REG_ID  
									FROM SUBJECT s JOIN SUB_REGISTER sr 
																		ON s.SUB_REG_ID = sr.REG_ID 
								WHERE sr.REG_AUTH =#{reg_auth}	
								AND sr.REG_ID = #{sub_reg_id}
									)
				WHERE SUB_NUM = #{sub_num}
</update>

</mapper>
